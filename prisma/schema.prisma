// Prisma Schema cho Hệ thống Đăng ký Ký túc xá UTEHY
// Database: PostgreSQL
// ORM: Prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTHENTICATION & USER MANAGEMENT
// ============================================

enum UserRole {
  STUDENT // Sinh viên
  ADMIN // Quản lý ký túc xá
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String // Hashed password
  role      UserRole @default(STUDENT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  student Student? // One-to-one với Student nếu role = STUDENT

  @@map("users")
}

// ============================================
// STUDENT INFORMATION
// ============================================

model Student {
  id          String   @id @default(cuid())
  userId      String   @unique // Foreign key to User
  studentCode String   @unique // Mã sinh viên (VD: 2024001)
  fullName    String // Họ và tên
  gender      String // Giới tính: "Nam" hoặc "Nữ"
  dateOfBirth DateTime // Ngày sinh
  phoneNumber String // Số điện thoại
  email       String   @unique // Email sinh viên
  major       String // Ngành học
  course      String // Khóa học (VD: K18, K19)
  address     String   @db.Text // Địa chỉ thường trú
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  registrations    Registration[] // Một sinh viên có thể có nhiều phiếu đăng ký
  payments         Payment[] // Một sinh viên có thể có nhiều thanh toán
  transferRequests TransferRequest[] // Một sinh viên có thể có nhiều yêu cầu chuyển phòng

  @@map("students")
}

// ============================================
// DORMITORY MANAGEMENT
// ============================================

enum DormitoryGender {
  NAM // Ký túc xá nam
  NU // Ký túc xá nữ
}

model Dormitory {
  id          String          @id @default(cuid())
  name        String          @unique // Tên ký túc xá (VD: "Nhà A", "Nhà B")
  code        String          @unique // Mã ký túc xá (VD: "KTX-A")
  gender      DormitoryGender // Giới tính: NAM hoặc NU
  address     String          @db.Text // Địa chỉ
  description String?         @db.Text // Mô tả
  totalRooms  Int             @default(0) // Tổng số phòng
  isActive    Boolean         @default(true) // Trạng thái hoạt động
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  // Relations
  rooms Room[] // Một ký túc xá có nhiều phòng

  @@map("dormitories")
}

// ============================================
// ROOM MANAGEMENT
// ============================================

enum RoomType {
  PHONG_4 // Phòng 4 người
  PHONG_6 // Phòng 6 người
  PHONG_8 // Phòng 8 người
}

model Room {
  id               String   @id @default(cuid())
  dormitoryId      String // Foreign key to Dormitory
  roomNumber       String // Số phòng (VD: "101", "202")
  floor            Int // Tầng
  roomType         RoomType // Loại phòng
  capacity         Int // Sức chứa tối đa (số giường)
  occupied         Int      @default(0) // Số giường đã được đặt
  pricePerSemester Decimal  @db.Decimal(10, 2) // Giá thuê/học kỳ (VNĐ)
  description      String?  @db.Text // Mô tả phòng
  isActive         Boolean  @default(true) // Trạng thái hoạt động
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  dormitory        Dormitory         @relation(fields: [dormitoryId], references: [id], onDelete: Cascade)
  beds             Bed[] // Một phòng có nhiều giường
  registrations    Registration[] // Một phòng có nhiều phiếu đăng ký
  meterReadings    MeterReading[] // Ghi chỉ số điện nước
  utilityBills     UtilityBill[] // Hóa đơn điện nước
  currentTransfers TransferRequest[] @relation("CurrentRoom") // Yêu cầu chuyển phòng từ phòng này
  newTransfers     TransferRequest[] @relation("NewRoom") // Yêu cầu chuyển phòng đến phòng này

  @@unique([dormitoryId, roomNumber]) // Số phòng phải unique trong một ký túc xá
  @@map("rooms")
}

// ============================================
// BED MANAGEMENT
// ============================================

enum BedStatus {
  AVAILABLE // Giường trống
  OCCUPIED // Đã có người
  RESERVED // Đã đặt trước
  MAINTENANCE // Đang bảo trì
}

model Bed {
  id          String    @id @default(cuid())
  roomId      String // Foreign key to Room
  bedNumber   String // Số giường (VD: "1", "2", "A", "B")
  status      BedStatus @default(AVAILABLE)
  description String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  room             Room              @relation(fields: [roomId], references: [id], onDelete: Cascade)
  registrations    Registration[] // Một giường có thể có nhiều phiếu đăng ký (theo thời gian)
  currentTransfers TransferRequest[] @relation("CurrentBed") // Yêu cầu chuyển phòng từ giường này
  newTransfers     TransferRequest[] @relation("NewBed") // Yêu cầu chuyển phòng đến giường này

  @@unique([roomId, bedNumber]) // Số giường phải unique trong một phòng
  @@map("beds")
}

// ============================================
// REGISTRATION MANAGEMENT
// ============================================

enum RegistrationStatus {
  CHO_XAC_NHAN // Chờ xác nhận
  DA_XAC_NHAN // Đã xác nhận
  DA_THANH_TOAN // Đã thanh toán
  DA_HUY // Đã hủy
  TU_CHOI // Từ chối
}

enum TransferStatus {
  CHO_XAC_NHAN // Chờ xác nhận
  DA_DUYET // Đã duyệt
  TU_CHOI // Từ chối
  DA_HOAN_TAT // Đã hoàn tất
}

enum Semester {
  HK1_2024_2025 // Học kỳ 1 năm học 2024-2025
  HK2_2024_2025 // Học kỳ 2 năm học 2024-2025
  HK1_2025_2026
  HK2_2025_2026
}

model Registration {
  id           String             @id @default(cuid())
  studentId    String // Foreign key to Student
  roomId       String // Foreign key to Room
  bedId        String? // Foreign key to Bed (optional, có thể chưa chọn giường cụ thể)
  semester     Semester // Học kỳ đăng ký
  status       RegistrationStatus @default(CHO_XAC_NHAN)
  registeredAt DateTime           @default(now()) // Thời gian đăng ký
  confirmedAt  DateTime? // Thời gian xác nhận
  paidAt       DateTime? // Thời gian thanh toán
  cancelledAt  DateTime? // Thời gian hủy
  notes        String?            @db.Text // Ghi chú
  adminNotes   String?            @db.Text // Ghi chú của admin
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  // Relations
  student Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  room    Room     @relation(fields: [roomId], references: [id], onDelete: Restrict)
  bed     Bed?     @relation(fields: [bedId], references: [id], onDelete: SetNull)
  payment Payment? // Liên kết với thanh toán (optional)

  @@map("registrations")
}

// ============================================
// PAYMENT MANAGEMENT
// ============================================

enum PaymentStatus {
  PENDING // Chờ thanh toán
  PROCESSING // Đang xử lý
  COMPLETED // Hoàn thành
  FAILED // Thất bại
  CANCELLED // Đã hủy
  REFUNDED // Đã hoàn tiền
}

enum PaymentMethod {
  VNPAY_QR // VNPay QR Code
  VNPAY_ATM // VNPay ATM
  VNPAY_BANK // VNPay Internet Banking
  CASH // Tiền mặt (thanh toán thủ công)
}

model Payment {
  id            String        @id @default(cuid())
  amount        Decimal       @db.Decimal(10, 2) // Số tiền thanh toán
  currency      String        @default("VND") // Đơn vị tiền tệ
  status        PaymentStatus @default(PENDING)
  method        PaymentMethod @default(VNPAY_QR)
  transactionId String?       @unique // Mã giao dịch từ VNPay
  orderInfo     String // Thông tin đơn hàng
  paymentUrl    String? // URL thanh toán VNPay
  qrCodeUrl     String? // URL QR code
  paidAt        DateTime? // Thời gian thanh toán thành công
  failedAt      DateTime? // Thời gian thất bại
  cancelledAt   DateTime? // Thời gian hủy
  refundedAt    DateTime? // Thời gian hoàn tiền
  refundAmount  Decimal?      @db.Decimal(10, 2) // Số tiền hoàn
  refundReason  String? // Lý do hoàn tiền
  notes         String?       @db.Text // Ghi chú
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  registrationId String?       @unique // Liên kết với phiếu đăng ký
  registration   Registration? @relation(fields: [registrationId], references: [id], onDelete: SetNull)
  studentId      String // Sinh viên thực hiện thanh toán
  student        Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("payments")
}

// ============================================
// UTILITY MANAGEMENT (Điện Nước)
// ============================================

enum BillStatus {
  PENDING // Chờ thanh toán
  PAID // Đã thanh toán
  OVERDUE // Quá hạn
  CANCELLED // Đã hủy
}

model UtilityRate {
  id              String    @id @default(cuid())
  electricityRate Decimal   @db.Decimal(10, 2) // Đơn giá điện (VNĐ/kWh)
  waterRate       Decimal   @db.Decimal(10, 2) // Đơn giá nước (VNĐ/m³)
  effectiveFrom   DateTime // Ngày bắt đầu áp dụng
  effectiveTo     DateTime? // Ngày kết thúc áp dụng (null = hiện tại)
  description     String?   @db.Text // Mô tả biểu giá
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("utility_rates")
}

model MeterReading {
  id                 String   @id @default(cuid())
  roomId             String // Foreign key to Room
  month              Int // Tháng (1-12)
  year               Int // Năm
  electricityReading Int      @default(0) // Chỉ số điện (kWh)
  waterReading       Int      @default(0) // Chỉ số nước (m³)
  recordedBy         String // Admin ID ghi nhận
  recordedAt         DateTime @default(now()) // Thời gian ghi nhận
  notes              String?  @db.Text // Ghi chú
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  room Room @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@unique([roomId, month, year]) // Mỗi phòng chỉ có 1 lần ghi chỉ số/tháng
  @@map("meter_readings")
}

model UtilityBill {
  id                String     @id @default(cuid())
  roomId            String // Foreign key to Room
  month             Int // Tháng
  year              Int // Năm
  electricityUsage  Int        @default(0) // Tiêu thụ điện (kWh)
  waterUsage        Int        @default(0) // Tiêu thụ nước (m³)
  electricityAmount Decimal    @default(0) @db.Decimal(10, 2) // Tiền điện
  waterAmount       Decimal    @default(0) @db.Decimal(10, 2) // Tiền nước
  totalAmount       Decimal    @default(0) @db.Decimal(10, 2) // Tổng tiền
  status            BillStatus @default(PENDING) // Trạng thái
  dueDate           DateTime // Hạn thanh toán
  paidAt            DateTime? // Thời gian thanh toán
  paidBy            String? // Người thanh toán
  notes             String?    @db.Text // Ghi chú
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  // Relations
  room Room @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@unique([roomId, month, year]) // Mỗi phòng chỉ có 1 hóa đơn/tháng
  @@map("utility_bills")
}

// ============================================
// TRANSFER REQUEST MANAGEMENT
// ============================================

model TransferRequest {
  id            String         @id @default(cuid())
  studentId     String // Foreign key to Student
  currentRoomId String // Foreign key to Room (phòng hiện tại)
  newRoomId     String // Foreign key to Room (phòng mới)
  currentBedId  String? // Foreign key to Bed (giường hiện tại)
  newBedId      String? // Foreign key to Bed (giường mới)
  semester      Semester // Học kỳ chuyển phòng
  reason        String         @db.Text // Lý do chuyển phòng
  status        TransferStatus @default(CHO_XAC_NHAN)
  requestedAt   DateTime       @default(now()) // Thời gian yêu cầu
  approvedAt    DateTime? // Thời gian duyệt
  rejectedAt    DateTime? // Thời gian từ chối
  completedAt   DateTime? // Thời gian hoàn tất
  adminNotes    String?        @db.Text // Ghi chú của admin
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // Relations
  student     Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  currentRoom Room    @relation("CurrentRoom", fields: [currentRoomId], references: [id])
  newRoom     Room    @relation("NewRoom", fields: [newRoomId], references: [id])
  currentBed  Bed?    @relation("CurrentBed", fields: [currentBedId], references: [id])
  newBed      Bed?    @relation("NewBed", fields: [newBedId], references: [id])

  @@map("transfer_requests")
}

// ============================================
// INDEXES FOR PERFORMANCE
// ============================================

// Index cho tìm kiếm nhanh
// Prisma tự động tạo index cho @unique và @id
// Thêm index cho các trường thường xuyên query
